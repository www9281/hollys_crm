--------------------------------------------------------
--  DDL for Function FC_SOL_TO_LUN
--------------------------------------------------------

  CREATE OR REPLACE FUNCTION "CRMDEV"."FC_SOL_TO_LUN" ( AS_SOL_DATE IN VARCHAR2 )
RETURN  VARCHAR2 
IS 
-------------------------------------------------------------------------------
--
--  TITLE       : SF_SOLAR_TO_LUNAR
--  DESCRIPTION : 양력일자를 받아서 음력일자로 변환
--  INPUT       : 양력일자
--  OUTPUT      : 음력일자
--
-------------------------------------------------------------------------------
-- WORKING VARIABLES
--W_PROGRAM_ID            VARCHAR2( 50 )  := 'SF_SOLAR_TO_LUNAR'       ;
--W_ERR                   BOOLEAN         := FALSE                ;
-- ARRAY TYPE 선언
TYPE ARRTYP IS TABLE OF VARCHAR2(10000)
INDEX BY BINARY_INTEGER;    
LS_LTBL             ARRTYP;
LL_DT               ARRTYP;
LL_DAY_PER_MONTH    ARRTYP;
LL_I                NUMBER;
LL_I2               NUMBER;
LL_J                NUMBER;
LL_M1               NUMBER;
LL_M2               NUMBER;
LL_TOTAL_DAY0       NUMBER;
LL_TOTAL_DAY        NUMBER;
LL_TOTAL_DAY1       NUMBER;
LL_TOTAL_DAY2       NUMBER;
LL_K11              NUMBER;
LL_COUNT            NUMBER;
LL_LUN_YEAR         NUMBER;
LL_IN_YEAR          NUMBER;
LL_IN_MONTH         NUMBER;
LL_IN_DAY           NUMBER;
AS_LUN_DATE     VARCHAR2(8);
BEGIN 
    -- 1881
    LS_LTBL(1) := '1212122322121';
    LS_LTBL(2) := '1212121221220';
    LS_LTBL(3) := '1121121222120';
    LS_LTBL(4) := '2112132122122';
    LS_LTBL(5) := '2112112121220';
    LS_LTBL(6) := '2121211212120';
    LS_LTBL(7) := '2212321121212';
    LS_LTBL(8) := '2122121121210';
    LS_LTBL(9) := '2122121212120';
    LS_LTBL(10) := '1232122121212';
    -- 1891
    LS_LTBL(11) := '1212121221220';
    LS_LTBL(12) := '1121123221222';
    LS_LTBL(13) := '1121121212220';
    LS_LTBL(14) := '1212112121220';
    LS_LTBL(15) := '2121231212121';
    LS_LTBL(16) := '2221211212120';
    LS_LTBL(17) := '1221212121210';
    LS_LTBL(18) := '2123221212121';
    LS_LTBL(19) := '2121212212120';
    LS_LTBL(20) := '1211212232212';
    -- 1901
    LS_LTBL(21) := '1211212122210';
    LS_LTBL(22) := '2121121212220';
    LS_LTBL(23) := '1212132112212';
    LS_LTBL(24) := '2212112112210';
    LS_LTBL(25) := '2212211212120';
    LS_LTBL(26) := '1221412121212';
    LS_LTBL(27) := '1212122121210';
    LS_LTBL(28) := '2112212122120';
    LS_LTBL(29) := '1231212122212';
    LS_LTBL(30) := '1211212122210';
    -- 1911
    LS_LTBL(31) := '2121123122122';
    LS_LTBL(32) := '2121121122120';
    LS_LTBL(33) := '2212112112120';
    LS_LTBL(34) := '2212231212112';
    LS_LTBL(35) := '2122121212120';
    LS_LTBL(36) := '1212122121210';
    LS_LTBL(37) := '2132122122121';
    LS_LTBL(38) := '2112121222120';
    LS_LTBL(39) := '1211212322122';
    LS_LTBL(40) := '1211211221220';
    -- 1921
    LS_LTBL(41) := '2121121121220';
    LS_LTBL(42) := '2122132112122';
    LS_LTBL(43) := '1221212121120';
    LS_LTBL(44) := '2121221212110';
    LS_LTBL(45) := '2122321221212';
    LS_LTBL(46) := '1121212212210';
    LS_LTBL(47) := '2112121221220';
    LS_LTBL(48) := '1231211221222';
    LS_LTBL(49) := '1211211212220';
    LS_LTBL(50) := '1221123121221';
    -- 1931
    LS_LTBL(51) := '2221121121210';
    LS_LTBL(52) := '2221212112120';
    LS_LTBL(53) := '1221241212112';
    LS_LTBL(54) := '1212212212120';
    LS_LTBL(55) := '1121212212210';
    LS_LTBL(56) := '2114121212221';
    LS_LTBL(57) := '2112112122210';
    LS_LTBL(58) := '2211211412212';
    LS_LTBL(59) := '2211211212120';
    LS_LTBL(60) := '2212121121210';
    -- 1941
    LS_LTBL(61) := '2212214112121';
    LS_LTBL(62) := '2122122121120';
    LS_LTBL(63) := '1212122122120';
    LS_LTBL(64) := '1121412122122';
    LS_LTBL(65) := '1121121222120';
    LS_LTBL(66) := '2112112122120';
    LS_LTBL(67) := '2231211212122';
    LS_LTBL(68) := '2121211212120';
    LS_LTBL(69) := '2212121321212';
    LS_LTBL(70) := '2122121121210';
    -- 1951
    LS_LTBL(71) := '2122121212120';
    LS_LTBL(72) := '1212142121212';
    LS_LTBL(73) := '1211221221220';
    LS_LTBL(74) := '1121121221220';
    LS_LTBL(75) := '2114112121222';
    LS_LTBL(76) := '1212112121220';
    LS_LTBL(77) := '2121211232122';
    LS_LTBL(78) := '1221211212120';
    LS_LTBL(79) := '1221212121210';
    LS_LTBL(80) := '2121223212121';
    -- 1961
    LS_LTBL(81) := '2121212212120';
    LS_LTBL(82) := '1211212212210';
    LS_LTBL(83) := '2121321212221';
    LS_LTBL(84) := '2121121212220';
    LS_LTBL(85) := '1212112112210';
    LS_LTBL(86) := '2223211211221';
    LS_LTBL(87) := '2212211212120';
    LS_LTBL(88) := '1221212321212';
    LS_LTBL(89) := '1212122121210';
    LS_LTBL(90) := '2112212122120';
    -- 1971
    LS_LTBL(91) := '1211232122212';
    LS_LTBL(92) := '1211212122210';
    LS_LTBL(93) := '2121121122210';
    LS_LTBL(94) := '2212312112212';
    LS_LTBL(95) := '2212112112120';
    LS_LTBL(96) := '2212121232112';
    LS_LTBL(97) := '2122121212110';
    LS_LTBL(98) := '2212122121210';
    LS_LTBL(99) := '2112124122121';
    LS_LTBL(100) := '2112121221220';
    -- 1981
    LS_LTBL(101) := '1211211221220'; 
    LS_LTBL(102) := '2121321122122';
    LS_LTBL(103) := '2121121121220';
    LS_LTBL(104) := '2122112112322';
    LS_LTBL(105) := '1221212112120';
    LS_LTBL(106) := '1221221212110';
    LS_LTBL(107) := '2122123221212';
    LS_LTBL(108) := '1121212212210';
    LS_LTBL(109) := '2112121221220';
    LS_LTBL(110) := '1211231212222';
    -- 1991
    LS_LTBL(111) := '1211211212220';
    LS_LTBL(112) := '1221121121220';
    LS_LTBL(113) := '1223212112121';
    LS_LTBL(114) := '2221212112120';
    LS_LTBL(115) := '1221221232112';
    LS_LTBL(116) := '1212212122120';
    LS_LTBL(117) := '1121212212210';
    LS_LTBL(118) := '2112132212221';
    LS_LTBL(119) := '2112112122210';
    LS_LTBL(120) := '2211211212210';
    -- 2001
    LS_LTBL(121) := '2221321121212';
    LS_LTBL(122) := '2212121121210';
    LS_LTBL(123) := '2212212112120';
    LS_LTBL(124) := '1232212122112';
    LS_LTBL(125) := '1212122122120';
    LS_LTBL(126) := '1121212322122';
    LS_LTBL(127) := '1121121222120';
    LS_LTBL(128) := '2112112122120';
    LS_LTBL(129) := '2211231212122';
    LS_LTBL(130) := '2121211212120';
    -- 2011
    LS_LTBL(131) := '2122121121210';
    LS_LTBL(132) := '2124212112121';
    LS_LTBL(133) := '2122121212120';
    LS_LTBL(134) := '1212121223212';
    LS_LTBL(135) := '1211212221220';
    LS_LTBL(136) := '1121121221220';
    LS_LTBL(137) := '2112132121222';
    LS_LTBL(138) := '1212112121220';
    LS_LTBL(139) := '2121211212120';
    LS_LTBL(140) := '2122321121212';
    -- 2021
    LS_LTBL(141) := '1221212121210';
    LS_LTBL(142) := '2121221212120';
    LS_LTBL(143) := '1232121221212';
    LS_LTBL(144) := '1211212212210';
    LS_LTBL(145) := '2121123212221';
    LS_LTBL(146) := '2121121212220';
    LS_LTBL(147) := '1212112112220';
    LS_LTBL(148) := '1221231211221';
    LS_LTBL(149) := '2212211211220';
    LS_LTBL(150) := '1212212121210';
    -- 2031
    LS_LTBL(151) := '2123212212121';
    LS_LTBL(152) := '2112122122120';
    LS_LTBL(153) := '1211212322212';
    LS_LTBL(154) := '1211212122210';
    LS_LTBL(155) := '2121121122120';
    LS_LTBL(156) := '2212114112122';
    LS_LTBL(157) := '2212112112120';
    LS_LTBL(158) := '2212121211210';
    LS_LTBL(159) := '2212232121211';
    LS_LTBL(160) := '2122122121210';
    -- 2041
    LS_LTBL(161) := '2112122122120';
    LS_LTBL(162) := '1231212122212';
    LS_LTBL(163) := '1211211221220';
    LL_DAY_PER_MONTH(1) := 31;
    LL_DAY_PER_MONTH(2) := 0;
    LL_DAY_PER_MONTH(3) := 31;
    LL_DAY_PER_MONTH(4) := 30;
    LL_DAY_PER_MONTH(5) := 31;
    LL_DAY_PER_MONTH(6) := 30;
    LL_DAY_PER_MONTH(7) := 31;
    LL_DAY_PER_MONTH(8) := 31;
    LL_DAY_PER_MONTH(9) := 30;
    LL_DAY_PER_MONTH(10) := 31;
    LL_DAY_PER_MONTH(11) := 30;
    LL_DAY_PER_MONTH(12) := 31;   
    LL_TOTAL_DAY := 0;
    LL_IN_YEAR  := TO_NUMBER(SUBSTR(AS_SOL_DATE,1,4));
    LL_IN_MONTH := TO_NUMBER(SUBSTR(AS_SOL_DATE,5,2));
    LL_IN_DAY   := TO_NUMBER(SUBSTR(AS_SOL_DATE,7,2));
    IF LL_IN_YEAR < 1881 OR LL_IN_YEAR > 2043 THEN
        RETURN 'F';
    END IF;
    FOR LL_I IN 1..163
    LOOP
        LL_DT(LL_I) := 0;
        FOR LL_J IN 1..12
        LOOP
            IF (SUBSTR(LS_LTBL(LL_I),LL_J,1) = 1) OR (SUBSTR(LS_LTBL(LL_I),LL_J,1) = 3) THEN
                LL_DT(LL_I) := LL_DT(LL_I) + 29;
            ELSIF (SUBSTR(LS_LTBL(LL_I),LL_J,1) = 2) OR (SUBSTR(LS_LTBL(LL_I),LL_J,1) = 4) THEN
                LL_DT(LL_I) := LL_DT(LL_I) + 30;            
            END IF;
        END LOOP;
        IF (SUBSTR(LS_LTBL(LL_I),13,1) = 1) OR (SUBSTR(LS_LTBL(LL_I),13,1) = 3) THEN
            LL_DT(LL_I) := LL_DT(LL_I) + 29;
        ELSIF (SUBSTR(LS_LTBL(LL_I),13,1) = 2) OR (SUBSTR(LS_LTBL(LL_I),13,1) = 4) THEN
            LL_DT(LL_I) := LL_DT(LL_I) + 30;
        END IF;        
    END LOOP;
    -- 1880년 1월 30일까지의 총일수
    LL_TOTAL_DAY1 := ( 1880 * 365 ) + 1880 / 4 - 1880 / 100 + 1880 / 400 + 30;
    LL_K11 := LL_IN_YEAR - 1;
    -- 입력된 년도 1년전까지의 총일수
    LL_TOTAL_DAY2 := LL_K11 * 365 + LL_K11 / 4 - LL_K11 / 100 + LL_K11 / 400;
    IF MOD(LL_IN_YEAR, 400) = 0 OR MOD(LL_IN_YEAR, 100) <> 0 AND MOD(LL_IN_YEAR, 4) = 0 THEN
        LL_DAY_PER_MONTH(2) := 29;
    ELSE 
        LL_DAY_PER_MONTH(2) := 28;
    END IF;
    FOR LL_I IN 1..LL_IN_MONTH - 1
    LOOP
        LL_TOTAL_DAY2 := LL_TOTAL_DAY2 + LL_DAY_PER_MONTH(LL_I);
    END LOOP;        
    -- 입력된 일자까지의 총일수
    LL_TOTAL_DAY2 := LL_TOTAL_DAY2 + LL_IN_DAY;
    -- 1880-01-30 부터 현재까지의 총일수
    LL_TOTAL_DAY  := LL_TOTAL_DAY2 - LL_TOTAL_DAY1;-- + 1;
    -- 1881년부터 현재까지의 총일수와 TABLE상의 숫자(음력)들의 합을 비교 반복
    LL_TOTAL_DAY0 := LL_DT(1);
    FOR LL_I IN 1..163
    LOOP
        IF LL_TOTAL_DAY <= LL_TOTAL_DAY0 THEN 
            LL_I2 := LL_I;
            EXIT;
        END IF;
        LL_TOTAL_DAY0 := LL_TOTAL_DAY0 + LL_DT(LL_I + 1);
    END LOOP;
    -- 음력년도
    LL_LUN_YEAR := LL_I2 + 1880;
    AS_LUN_DATE := LPAD(LL_LUN_YEAR,4,'0');
    -- 현재년도의 음력일수 감산
    LL_TOTAL_DAY0 := LL_TOTAL_DAY0 - LL_DT(LL_I2);
    -- 양력 총일수에서 음력 총일수 감산 
    LL_TOTAL_DAY  := LL_TOTAL_DAY - LL_TOTAL_DAY0;
    IF SUBSTR(LS_LTBL(LL_I2), 13, 1) = '0' THEN
        LL_COUNT := 12;
    ELSE
        LL_COUNT := 13;
    END IF;
    LL_M2 := 0;
    FOR LL_J IN 1..LL_COUNT
    LOOP
        IF SUBSTR(LS_LTBL(LL_I2),LL_J, 1) <= '2' THEN
            LL_M2 := LL_M2 + 1;
            LL_M1 := TO_NUMBER(SUBSTR(LS_LTBL(LL_I2), LL_J, 1)) + 28;
        ELSE
            LL_M1 := TO_NUMBER(SUBSTR(LS_LTBL(LL_I2), LL_J, 1)) + 26;
        END IF;
        IF LL_TOTAL_DAY <= LL_M1 THEN  
            EXIT;
        END IF;
        LL_TOTAL_DAY := LL_TOTAL_DAY - LL_M1;
    END LOOP;
    LL_TOTAL_DAY := ROUND(LL_TOTAL_DAY);
    --DBMS_OUTPUT.PUT_LINE( 'AS_LUN_DATE :'|| AS_LUN_DATE); 
    --DBMS_OUTPUT.PUT_LINE( 'LL_M2 :'|| LL_M2); 
    --DBMS_OUTPUT.PUT_LINE( 'LL_TOTAL_DAY :'|| LL_TOTAL_DAY); 
    -- 음력일자
    AS_LUN_DATE := AS_LUN_DATE||LPAD(LL_M2,2,'0') || LPAD(LL_TOTAL_DAY, 2,'0');
    RETURN AS_LUN_DATE;
END;

/
